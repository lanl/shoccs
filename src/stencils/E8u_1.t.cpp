#include "stencil.hpp"

#include <catch2/catch_approx.hpp>
#include <catch2/catch_test_macros.hpp>
#include <catch2/matchers/catch_matchers_vector.hpp>

#include <vector>

#include <range/v3/view/zip.hpp>

#include <sol/sol.hpp>
#include <spdlog/spdlog.h>

using Catch::Matchers::Approx;
using namespace ccs;

TEST_CASE("E8u_1")
{
    using T = std::vector<real>;
    sol::state lua;
    lua.open_libraries(sol::lib::base, sol::lib::math);
    lua.script(R"(
        simulation = {
            scheme = {
                order = 1,
                type = "E8u",
                alpha = {-0.6484343281044554,
0.1546307245964576,
-0.0024361150534464,
-0.0767677234359209,
0.0395245547501803,
-0.25779890216368,
0.0527307049447768}
            }
        }
    )");

    auto st_opt = stencil::from_lua(lua["simulation"]);
    REQUIRE(!!st_opt);
    const auto& st = *st_opt;

    {

        auto [p, r, t, x] = st.query(bcs::Floating);
        REQUIRE(p == 4);
        REQUIRE(r == 7);
        REQUIRE(t == 11);
        REQUIRE(x == 0);

        T c(r * t);
        T ex{};

        st.nbs(2, bcs::Floating, 1.0, false, c, ex);
        REQUIRE_THAT(c,
                     Approx(T{-1.620645735480799,
                              6.093737312417822,
                              -14.328080593462376,
                              23.989494520258084,
                              -27.07020148365594,
                              20.256161186924754,
                              -9.66141392679571,
                              2.6651658838463934,
                              -0.3242171640522277,
                              0.0,
                              0.0,
                              0.005886790869657372,
                              -1.3435228983858305,
                              3.6648301443504065,
                              -5.579660288700813,
                              6.24540869420935,
                              -4.704660288700813,
                              2.2648301443504066,
                              -0.6304276602905923,
                              0.0773153622982288,
                              0.0,
                              0.0,
                              0.010686704378038705,
                              -0.15692220645288107,
                              -0.42577227741491624,
                              0.9015445548298325,
                              -0.5019306935372907,
                              0.23487788816316588,
                              -0.07577227741491627,
                              0.014506364975690363,
                              -0.0012180575267232,
                              0.0,
                              0.0,
                              -0.04314576647986521,
                              0.3570708937436836,
                              -1.3747481281028926,
                              2.0244962562057855,
                              -2.1868703202572317,
                              1.9994962562057854,
                              -1.0414147947695593,
                              0.30349946517225507,
                              -0.03838386171796045,
                              0.0,
                              0.0,
                              0.023333705946518724,
                              -0.19143155233405454,
                              0.7033437665025243,
                              -1.6066875330050485,
                              1.5083594162563105,
                              -0.8066875330050485,
                              0.5033437665025242,
                              -0.15333631423881644,
                              0.01976227737509015,
                              0.0,
                              0.0,
                              0.07726146393536244,
                              -0.5881549304390825,
                              1.9190648370777077,
                              -3.4384121111534216,
                              3.4318427370216202,
                              -2.3560673073131086,
                              0.9868612517363978,
                              0.07013815774397571,
                              -0.12889945108184,
                              0.0263653524723884,
                              0.0,
                              -0.058467796419719775,
                              0.4371229276793953,
                              -1.3903775683566566,
                              2.397968815999491,
                              -2.278631808271436,
                              0.7319853517776528,
                              0.07615328403773296,
                              0.01154775812234574,
                              0.085912848127809,
                              -0.01140756609377972,
                              -0.0018062466028348036})
                         .margin(1.0e-8));
    }
    {
        auto [p, r, t, x] = st.query(bcs::Dirichlet);
        REQUIRE(p == 4);
        REQUIRE(r == 6);
        REQUIRE(t == 11);
        REQUIRE(x == 0);

        T c(r * t);
        T ex{};

        st.nbs(0.5, bcs::Dirichlet, 0.0, false, c, ex);
        REQUIRE_THAT(c,
                     Approx(T{0.02354716347862949,
                              -5.374091593543322,
                              14.659320577401626,
                              -22.318641154803252,
                              24.9816347768374,
                              -18.818641154803252,
                              9.059320577401627,
                              -2.521710641162369,
                              0.3092614491929152,
                              0.0,
                              0.0,
                              0.04274681751215482,
                              -0.6276888258115243,
                              -1.703089109659665,
                              3.60617821931933,
                              -2.007722774149163,
                              0.9395115526526635,
                              -0.30308910965966507,
                              0.05802545990276145,
                              -0.0048722301068928,
                              0.0,
                              0.0,
                              -0.17258306591946085,
                              1.4282835749747345,
                              -5.49899251241157,
                              8.097985024823142,
                              -8.747481281028927,
                              7.997985024823142,
                              -4.165659179078237,
                              1.2139978606890203,
                              -0.1535354468718418,
                              0.0,
                              0.0,
                              0.0933348237860749,
                              -0.7657262093362182,
                              2.813375066010097,
                              -6.426750132020194,
                              6.033437665025242,
                              -3.226750132020194,
                              2.013375066010097,
                              -0.6133452569552658,
                              0.0790491095003606,
                              0.0,
                              0.0,
                              0.30904585574144977,
                              -2.35261972175633,
                              7.676259348310831,
                              -13.753648444613686,
                              13.727370948086481,
                              -9.424269229252435,
                              3.9474450069455913,
                              0.28055263097590283,
                              -0.51559780432736,
                              0.1054614098895536,
                              0.0,
                              -0.2338711856788791,
                              1.7484917107175812,
                              -5.561510273426626,
                              9.591875263997965,
                              -9.114527233085743,
                              2.927941407110611,
                              0.30461313615093183,
                              0.04619103248938296,
                              0.343651392511236,
                              -0.04563026437511888,
                              -0.0072249864113392145})
                         .margin(1.0e-8));
    }
}
